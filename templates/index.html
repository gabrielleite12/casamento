<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <title>Cabine de Fotos - Casamento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* Seu CSS original aqui */
    /* ... (mantive o CSS que você já tinha) */
  </style>
</head>
<body>
  <h2>💍 Cabine de Fotos do Casamento</h2>

  {% with messages = get_flashed_messages() %}
    {% if messages %}
      <ul>
      {% for message in messages %}
        <li>{{ message }}</li>
      {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

  <form method="post" enctype="multipart/form-data" id="upload-form">
    <label>
      📁 Selecionar da galeria:
      <input type="file" name="imagem" accept="image/*" />
    </label>
  </form>

  <h3>📷 Grave um vídeo segurando o botão</h3>
  <button id="abrirCamera">Abrir câmera</button>

  <video id="camera" autoplay></video>
  <div class="overlay-buttons" id="botoesCamera" style="display: none;">
    <button id="recordBtn">🎥 Segure para gravar</button>
  </div>

  <!-- Tela de pré-visualização -->
  <div id="preview-fullscreen" style="display:none; flex-direction: column; align-items: center; justify-content: center;">
    <video id="preview-video" controls style="max-width: 100%; max-height: 80vh; border-radius: 12px; box-shadow: 0 0 10px rgba(0,0,0,0.15);"></video>
    <div class="overlay-buttons" style="margin-top: 10px;">
      <form method="post" enctype="multipart/form-data" id="video-form">
        <input type="hidden" name="captured_video" id="captured-video" />
        <button type="submit">✅ Usar este vídeo</button>
        <button type="button" onclick="refazer()">🔁 Gravar outro</button>
      </form>
    </div>
  </div>

<script>
  const abrirCameraBtn = document.getElementById('abrirCamera');
  const video = document.getElementById('camera');
  const botoesCamera = document.getElementById('botoesCamera');
  const previewFullscreen = document.getElementById('preview-fullscreen');
  const previewVideo = document.getElementById('preview-video');
  const capturedVideoInput = document.getElementById('captured-video');
  const recordBtn = document.getElementById('recordBtn');

  let stream = null;
  let mediaRecorder = null;
  let chunks = [];

  abrirCameraBtn.addEventListener('click', () => {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: true })
      .then(s => {
        stream = s;
        video.srcObject = stream;
        video.style.display = 'block';
        botoesCamera.style.display = 'flex';
        abrirCameraBtn.style.display = 'none';
      })
      .catch(err => {
        alert("Erro ao acessar a câmera: " + err.message);
      });
  });

  recordBtn.addEventListener('mousedown', () => {
    if (!stream) return alert('Abra a câmera antes.');

    chunks = [];
    mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm; codecs=vp8' });

    mediaRecorder.ondataavailable = e => {
      if (e.data.size > 0) chunks.push(e.data);
    };

    mediaRecorder.onstop = () => {
      const blob = new Blob(chunks, { type: 'video/webm' });
      const videoURL = URL.createObjectURL(blob);

      capturedVideoInput.value = ''; // reset
      // Converter Blob para base64 e enviar (opcional, mas ideal para enviar no POST)
      const reader = new FileReader();
      reader.onloadend = function() {
        capturedVideoInput.value = reader.result;
      };
      reader.readAsDataURL(blob);

      previewVideo.src = videoURL;
      previewVideo.style.display = 'block';

      // Parar a câmera
      video.pause();
      stream.getTracks().forEach(track => track.stop());
      video.style.display = 'none';
      botoesCamera.style.display = 'none';

      previewFullscreen.style.display = 'flex';
    };

    mediaRecorder.start();
    recordBtn.textContent = '⏹ Solte para parar';
  });

  recordBtn.addEventListener('mouseup', () => {
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
      recordBtn.textContent = '🎥 Segure para gravar';
    }
  });

  recordBtn.addEventListener('mouseleave', () => {
    // Caso solte o botão fora da área
    if (mediaRecorder && mediaRecorder.state === 'recording') {
      mediaRecorder.stop();
      recordBtn.textContent = '🎥 Segure para gravar';
    }
  });

  function refazer() {
    previewFullscreen.style.display = 'none';
    previewVideo.src = '';
    capturedVideoInput.value = '';
    abrirCameraBtn.style.display = 'inline-block';
  }
</script>
</body>
</html>
